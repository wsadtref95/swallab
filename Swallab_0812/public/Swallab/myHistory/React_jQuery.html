<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- css -->
    <link href="../css/root.css" rel="stylesheet">
    <link href="../css/nav.css" rel="stylesheet">
    <link href="../css/footer.css" rel="stylesheet">
    <!-- bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
    <!-- css -->
    <link rel="stylesheet" href="../css/history_react.css">
    <link rel="stylesheet" href="../css/myHistory.css">
    <link rel="stylesheet" href="../css/myHistory_temp_order.css">
    <!-- <link rel="stylesheet" href="../css/history_react.css"> -->
    <!-- icon -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
        integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <!-- React -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>

<body>
    <!-- NAV_begin : sticky-top -->
    <nav class="navbar navbar-expand sticky-top shadow">
        <div class="container">
            <!-- LOGO -->
            <a class="navbar-brand ms-5 col-1" href="../headpage/headpage.html">
                <img src="../images/root/logo.jpg" alt="" class="logo d-inline-block align-text-top">
            </a>
            <!-- 伸縮 -->
            <div class="collapse navbar-collapse col-10" id="navbarSupportedContent">
                <div class="nav ms-0 me-3 row">
                    <div class="nav-item col-6">
                        <!-- 首頁沒有 active -->
                        <!-- <a class="nav-link active" aria-current="page" href="#">Active</a> -->
                        <a class="nav-link d-block nav_mainbtn" href="../restaurant/detail.html">找餐廳</a>
                    </div>
                    <div class="nav-item col-6">
                        <a class="nav-link d-block nav_mainbtn" href="../foodNotes/foodNotes.html">看食記</a>
                    </div>
                </div>
                <!-- Input 都在這 -->
                <form method="post" action="/profile" class="ms-2 me-1 w-100" role="search" name="search">
                    <!-- @csrf -->
                    <div class="d-flex" style="width: 100%;">
                        <!-- hover、click 換 icon -> src="./img/blog.png" -->
                        <div id="theicon" class="theicon mt-2 me-0 align-items-center justify-content-center">
                            <div id="popup" class="popup text-center d-flex align-items-center justify-content-center">
                                <p><i id="showicon" class=""></i></p>
                            </div>
                            <div id="popupBR" class="popupBR">
                                <div id="popupBlog" class="col-4 text-center">
                                    <p class="text-center"><i class="fa-solid fa-book-open"></i></p>
                                </div>
                                <div id="popupRest" class="col-4 text-center">
                                    <p><i class="fa-solid fa-utensils"></i></p>
                                </div>
                            </div>
                        </div>



                        <!-- 搜尋框 + 情境按鈕(pill 會改成底線) -->
                        <div class="d-block position-relative m-0 p-0 col">
                            <!-- 搜尋框 start -->
                            <!-- <input class="form-control m-0" type="search" placeholder="Click" aria-label="Search"> -->
                            <div style="display: flex;" clas="row">
                                <div class="col-6">
                                    <input type="text" id="myInput" onclick="myFunction()" placeholder="點擊我"
                                        class="form-control m-0">
                                    <!-- from 資料庫 -->
                                    <div id="myDropdown" class="dropdown-content"
                                        style="display: none; position: absolute;">
                                        <a href="#cate_no" onclick="fillInput('null')"
                                            class="position-relative">不挑分類</a>
                                        <a href="#cate_hotpot" onclick="fillInput('火鍋')"
                                            class="position-relative">火鍋</a>
                                        <a href="#cate_bbq" onclick="fillInput('燒肉')" class="position-relative">燒肉</a>
                                        <a href="#cate_izakaya" onclick="fillInput('居酒屋')"
                                            class="position-relative">居酒屋</a>
                                        <a href="#cate_ramen" onclick="fillInput('拉麵')" class="position-relative">拉麵</a>
                                        <a href="#cate_dessert" onclick="fillInput('甜點')"
                                            class="position-relative">甜點</a>
                                    </div>
                                </div>
                                <div class="col-6">

                                    <input type="text" id="myInput2" onclick="myFunction2()" placeholder="點擊我"
                                        class="form-control m-0 col-6">
                                    <!-- from 資料庫 -->
                                    <div id="myDropdown2" class="dropdown-content"
                                        style="display: none; position: absolute;">
                                        <a href="#loc_no" onclick="fillInput2('null')"
                                            class="position-relative">不挑地區</a>
                                        <a href="#loc_Taichung" onclick="fillInput2('台中市')"
                                            class="position-relative">台中市</a>
                                        <a href="#loc_1" onclick="fillInput2('選項2')" class="position-relative">選項2</a>
                                        <a href="#loc_2" onclick="fillInput2('選項3')" class="position-relative">選項3</a>
                                    </div>
                                </div>
                            </div>



                            <!-- 搜尋框 end -->
                            <button class="position-absolute translate-middle rounded-pill filter_btn"
                                style="margin-left: 10%;">
                                <img class="icon" src="../images/nav_icon/dating.png" alt="">約會
                            </button>
                            <button class="position-absolute translate-middle rounded-pill filter_btn"
                                style="margin-left: 30%;">
                                <img class="icon" src="../images/nav_icon/group.png" alt="">聚餐
                            </button>
                            <button class="position-absolute translate-middle rounded-pill filter_btn"
                                style="margin-left: 50%;">
                                <img class="icon" src="../images/nav_icon/confetti.png" alt="">慶生
                            </button>
                            <button class="position-absolute translate-middle rounded-pill filter_btn"
                                style="margin-left: 70%;">
                                <img class="icon" src="../images/nav_icon/handshake.png" alt="">商務
                            </button>
                            <button class="position-absolute translate-middle rounded-pill filter_btn"
                                style="margin-left: 90%;">
                                <img class="icon" src="../images/nav_icon/disabled-people.png" alt="">無障礙
                            </button>
                        </div>
                        <!-- 搜尋 icon = submit -->
                        <input type="image" src="../images/nav_icon/loupe.png" class="icon mt-2 ms-0"
                            onclick="document.search.submit()">
                        <!-- <img src="./img/loupe.png" class="icon mt-2 ms-1" alt="" type="submit"> -->
                    </div>
                </form>
                <!-- 登入及註冊按鈕 -->
                <div class="ms-3 me-5 col-1">
                    <a href="#" class="">
                        <button class="btn btn-sm btnLogin text-nowrap">登入/註冊</button>
                    </a>
                </div>
            </div>
        </div>
    </nav>
    <!-- NAV_end -->


    <main>
        <div class="w-100 container mt-5" style="flex:1">
            <div id="root"></div>

            <!-- main content_end -->

        </div>
        </div>
    </main>

    <!-- Footer_begin -->
    <footer class="myFooter mt-3">
        <!-- 左右二欄 -->
        <div class="row justify-content-center mt-3 container">
            <!-- 左邊logo -->
            <div class="col-4 text-center"></div>
            <div class="col-2 justify-content-center">
                <img src="../images/root/logo.jpg" class="logo" alt="">
                <div class="text-center">
                    <span class="rights text-nowrap">© 版權聲明</span>
                </div>
            </div>
            <!-- 右邊三列 -->
            <div class="col-2">
                <div class="">
                    <a class="btn btnFooter text-nowrap">找餐廳</a>
                </div>
                <div class="">
                    <a class="btn btnFooter text-nowrap">看食記</a>
                </div>
                <div class="row justify-content-center">
                    <!-- 二個 icon -->
                    <a href="#" class="col-6 text-center">
                        <i class="fa-brands fa-facebook"></i> <!-- facebook -->
                    </a>
                    <a href="#" class="col-6 text-center">
                        <i class="fa-brands fa-instagram"></i> <!-- instagram -->
                    </a>
                </div>
            </div>
            <div class="col-4 text-center"></div>
        </div>
    </footer>
    <!-- Footer_end -->
    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback } = React;

        const API_BASE_URL = 'http://localhost:8000/api';

        function MemberActivity() {
            const [state, setState] = useState({
                activeTab: 'all',
                activities: [],
                hasMore: true,
                currentPage: 1,
                isLoading: true
            });

            useEffect(() => {
                fetchAllActivities();
            }, []);

            const fetchAllActivities = async () => {
                try {
                    setState(prev => ({ ...prev, isLoading: true }));
                    const response = await fetch(`${API_BASE_URL}/member-activity/all`);
                    if (!response.ok) throw new Error('Network response was not ok');
                    const data = await response.json();
                    const sortedActivities = sortActivitiesByDate(data);
                    setState(prev => ({
                        ...prev,
                        activities: sortedActivities,
                        isLoading: false
                    }));
                } catch (error) {
                    console.error('Error fetching all activities:', error);
                    setState(prev => ({ ...prev, isLoading: false }));
                }
            };

            const handleTabChange = async (tab) => {
                if (tab === 'all') {
                    fetchAllActivities();
                } else {
                    try {
                        setState(prev => ({ ...prev, isLoading: true, activeTab: tab }));
                        const response = await fetch(`${API_BASE_URL}/member-activity/${tab}?page=1&limit=10`);
                        if (!response.ok) throw new Error('Network response was not ok');
                        const data = await response.json();
                        setState(prev => ({
                            ...prev,
                            activities: data.data,
                            hasMore: data.next_page_url !== null,
                            currentPage: 1,
                            isLoading: false
                        }));
                    } catch (error) {
                        console.error(`Error fetching ${tab} activities:`, error);
                        setState(prev => ({ ...prev, isLoading: false }));
                    }
                }
            };

            const handleLoadMore = async () => {
                if (state.activeTab === 'all' || state.isLoading) return;

                try {
                    setState(prev => ({ ...prev, isLoading: true }));
                    const response = await fetch(`${API_BASE_URL}/member-activity/${state.activeTab}?page=${state.currentPage + 1}&limit=10`);
                    if (!response.ok) throw new Error('Network response was not ok');
                    const data = await response.json();
                    setState(prev => ({
                        ...prev,
                        activities: [...prev.activities, ...data.data],
                        hasMore: data.next_page_url !== null,
                        currentPage: prev.currentPage + 1,
                        isLoading: false
                    }));
                } catch (error) {
                    console.error('Error loading more activities:', error);
                    setState(prev => ({ ...prev, isLoading: false }));
                }
            };

            const sortActivitiesByDate = (data) => {
                const allActivities = [
                    ...(data.orders || []).map(item => ({ ...item, type: 'order' })),
                    ...(data.notes || []).map(item => ({ ...item, type: 'note' })),
                    ...(data.comments || []).map(item => ({ ...item, type: 'comment' })),
                    ...(data.favorites || []).map(item => ({ ...item, type: 'favorite' }))
                ];
                return allActivities.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
            };

            return (
                <div className="member-activity-container">
                    <div className="rightpart">
                        <div className="col">
                            <div className="row ms-5 justify-content-center">
                                {['all', 'OrderInfos', 'MemberNotes', 'Comments', 'Favorites'].map(tab => (
                                    <div className="col-2" key={tab}>
                                        <button
                                            className={`btn btn-outline-success tab-button ${state.activeTab === tab ? 'active' : ''}`}
                                            onClick={() => handleTabChange(tab)}
                                        >
                                            {tab === 'all' ? '全部' :
                                                tab === 'OrderInfos' ? '歷史訂單' :
                                                    tab === 'MemberNotes' ? '歷史食記' :
                                                        tab === 'Comments' ? '我的評論' : '我的收藏'}
                                        </button>
                                    </div>
                                ))}
                                <hr className="mt-3" />
                            </div>

                            {state.isLoading ? (
                                <p>Loading...</p>
                            ) : (
                                state.activities.map(activity => {
                                    switch (activity.type) {
                                        case 'order':
                                            return <OrderInfos key={activity.id} order={activity} />;
                                        case 'note':
                                            return <MemberNotes key={activity.id} note={activity} />;
                                        case 'comment':
                                            return <Comments key={activity.id} comment={activity} />;
                                        case 'favorite':
                                            return <Favorites key={activity.id} favorite={activity} />;
                                        default:
                                            return null;
                                    }
                                })
                            )}

                            {state.hasMore && !state.isLoading && state.activeTab !== 'all' && (
                                <button className="btn btn-outline-success" onClick={handleLoadMore}>觀看更多</button>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        // ReactDOM.createRoot(document.getElementById('root')).render(
        //     <React.StrictMode>
        //         <MemberActivity />
        //     </React.StrictMode>
        // );


        // function MemberActivity() {
        //     const [state, dispatch] = useReducer(reducer, {
        //         activeTab: 'all',
        //         activities: [],
        //         hasMore: true,
        //         currentPage: 1
        //     });

        //     const isLoadingRef = useRef(false);
        //     const fetchCountRef = useRef(0);
        //     const renderCountRef = useRef(0);

        //     const fetchActivities = useCallback(async () => {
        //         if (isLoadingRef.current) return;

        //         isLoadingRef.current = true;
        //         fetchCountRef.current += 1;
        //         console.log(`Fetching activities. Count: ${fetchCountRef.current}`);

        //         if (fetchCountRef.current > 10) {
        //             console.error('Fetch count exceeded limit. Stopping to prevent infinite loop.');
        //             return;
        //         }

        //         try {
        //             const endpoint = `${API_BASE_URL}/member-activity/${state.activeTab}`;
        //             console.log(`Fetching from endpoint: ${endpoint}?page=${state.currentPage}&limit=4`);

        //             const response = await fetch(`${endpoint}?page=${state.currentPage}&limit=4`);
        //             if (!response.ok) throw new Error('Network response was not ok');

        //             const data = await response.json();
        //             console.log('Received data:', data);

        //             const processedData = processData(data, state.activeTab);
        //             console.log('Processed data:', processedData);

        //             if (state.currentPage === 1) {
        //                 dispatch({ type: 'SET_ACTIVITIES', payload: processedData });
        //             } else {
        //                 dispatch({ type: 'APPEND_ACTIVITIES', payload: processedData });
        //             }

        //             dispatch({ type: 'SET_HAS_MORE', payload: data.next_page_url !== null });
        //         } catch (error) {
        //             console.error('Error fetching activities:', error);
        //         } finally {
        //             isLoadingRef.current = false;
        //         }
        //     }, [state.activeTab, state.currentPage]);

        //     useEffect(() => {
        //         renderCountRef.current += 1;
        //         console.log(`Component rendered ${renderCountRef.current} times`);

        //         if (renderCountRef.current > 100) {
        //             console.error('Render count exceeded limit. Possible infinite loop.');
        //             return;
        //         }

        //         fetchActivities();
        //     }, [fetchActivities]);

        //     const processData = (data, tab) => {
        //         if (tab === 'all') {
        //             return [
        //                 ...(data.orders || []).map(item => ({ ...item, type: 'order' })),
        //                 ...(data.notes || []).map(item => ({ ...item, type: 'note' })),
        //                 ...(data.comments || []).map(item => ({ ...item, type: 'comment' })),
        //                 ...(data.favorites || []).map(item => ({ ...item, type: 'favorite' }))
        //             ];
        //         } else {
        //             return data.data || [];
        //         }
        //     };

        //     const handleTabChange = (tab) => {
        //         console.log(`Changing tab to: ${tab}`);
        //         dispatch({ type: 'SET_TAB', payload: tab });
        //         fetchCountRef.current = 0;
        //     };

        //     const handleLoadMore = () => {
        //         console.log('Loading more items');
        //         dispatch({ type: 'INCREMENT_PAGE' });
        //     };

        //     // ... 其他處理函數保持不變 ...

        //     return (
        //         <div className="member-activity-container">
        //             <div className="rightpart">
        //                 {/* ... 側邊欄和麵包屑導航 ... */}
        //                 <div className="col">
        //                     <div className="row ms-5 justify-content-center">
        //                         {['all', 'OrderInfos', 'MemberNotes', 'Comments', 'Favorites'].map(tab => (
        //                             <div className="col-2" key={tab}>
        //                                 <button
        //                                     className={`btn btn-outline-success tab-button ${state.activeTab === tab ? 'active' : ''}`}
        //                                     onClick={() => handleTabChange(tab)}
        //                                 >
        //                                     {tab === 'all' ? '全部' :
        //                                         tab === 'OrderInfos' ? '歷史訂單' :
        //                                             tab === 'MemberNotes' ? '歷史食記' :
        //                                                 tab === 'Comments' ? '我的評論' : '我的收藏'}
        //                                 </button>
        //                             </div>
        //                         ))}
        //                         <hr className="mt-3" />
        //                     </div>

        //                     {isLoadingRef.current ? (
        //                         <p>Loading...</p>
        //                     ) : (
        //                         state.activities.map(activity => {
        //                             switch (activity.type) {
        //                                 case 'order':
        //                                     return <OrderInfos key={activity.id} order={activity} />;
        //                                 case 'note':
        //                                     return <MemberNotes key={activity.id} note={activity} />;
        //                                 case 'comment':
        //                                     return <Comments key={activity.id} comment={activity} onEdit={handleEditComment} onDelete={handleDeleteComment} />;
        //                                 case 'favorite':
        //                                     return <Favorites key={activity.id} favorite={activity} onDelete={handleDeleteFavorite} />;
        //                                 default:
        //                                     return null;
        //                             }
        //                         })
        //                     )}

        //                     {state.hasMore && !isLoadingRef.current && (
        //                         <button className="btn btn-outline-success" onClick={handleLoadMore}>觀看更多</button>
        //                     )}
        //                 </div>
        //             </div>
        //         </div>
        //     );
        // }

        function OrderInfos({ order }) {
            if (!order || !order.items) {
                return (
                    <div className="row mt-5 myRecordsTemp align-self-center">
                        <p>訂單信息不完整</p>
                    </div>
                );
            }
            return (
                <div className="row mt-5 myRecordsTemp align-self-center">
                    <div className="col-2">
                        <div className="myRecordsContainer align-self-center">
                            <img className="activity-image" src={order.restaurant_image} alt={order.restaurant_name} />
                        </div>
                    </div>
                    <div className="col-6">
                        <div className="activity-title">
                            <a href="#"><span>{order.restaurant_name}</span></a>
                        </div>
                        <div className="row myRecordsInfo container">
                            {Array.isArray(order.items) ? order.items.map((item, index) => (
                                <div key={index}>
                                    <span>{item.item_qty}</span>份 <span>{item.item_price}</span> 的 <span>{item.item_name}</span>
                                </div>
                            )) : <div>訂單項目不可用</div>}
                        </div>
                    </div>
                    <div className="col-2">
                        <div><span>${order.total_price} NT</span></div>
                    </div>
                    <div className="col-2 myRecordsBtn">
                        <div><span>{order.created_at_date}</span><br /> <span>{order.created_at_time}</span></div>
                        <button className="activity-button">檢視內容</button>
                    </div>
                </div>
            );
        }

        function MemberNotes({ note }) {
            return (
                <div className="row mt-5 myRecordsTemp align-self-center">
                    <div className="col-2">
                        <div className="myRecordsContainer align-self-center">
                            <img className="activity-image" src={note.main_photo} alt={note.title} />
                        </div>
                    </div>
                    <div className="col-8">
                        <div className="row activity-title">
                            <a href=""><span>{note.title}</span></a>
                        </div>
                        <div className="row myRecordsInfo container-fluid myNotes">
                            <div className="activity-content">{note.content}</div>
                        </div>
                    </div>
                    <div className="col-2">
                        <div><span>{note.created_at_date}</span> <br /><span>{note.created_at_time}</span> </div>
                        <div className="activity-buttons">
                            <button className="activity-button">
                                <i className="fa-solid fa-pen-to-square"></i>
                            </button>
                            <button className="activity-button">
                                <i className="fa-solid fa-trash-can"></i>
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        function Comments({ comment, onEdit, onDelete }) {
            const [isEditing, setIsEditing] = useState(false);
            const [commentType, setCommentType] = useState(comment.type); // 'restaurant' or 'note'

            const handleEdit = () => {
                onEdit(comment.id, editedContent);
                setIsEditing(false);
            };

            return (
                <div
                    onMouseEnter={() => setIsHovering(true)}
                    onMouseLeave={() => setIsHovering(false)}
                >
                    <div className="row mt-5 myRecordsTemp align-self-center">
                        <div className="col-2">
                            <div className="myRecordsContainer align-self-center">
                                <img className="activity-image" src={comment.restaurant_image} alt={comment.restaurant_name} />
                            </div>
                        </div>
                        <div className="col-8">
                            <div className="row myRecordsTitle">
                                <a href="#"><span>{comment.restaurant_name}</span></a>
                            </div>
                            <div className="row myRecordsContent container">
                                {isEditing ? (
                                    <textarea
                                        value={editedContent}
                                        onChange={(e) => setEditedContent(e.target.value)}
                                    />
                                ) : (
                                    comment.content
                                )}
                            </div>
                        </div>
                        <div className="col-2">
                            <div><span>{comment.created_at_date}</span> <br /><span>{comment.created_at_time}</span> </div>
                            <div className="activity-buttons">
                                {isEditing ? (
                                    <>
                                        <button className="activity-button" onClick={handleEdit}>保存</button>
                                        <button className="activity-button" onClick={() => setIsEditing(false)}>取消</button>
                                    </>
                                ) : (
                                    <>
                                        <button className="activity-button" onClick={() => setIsEditing(true)}>
                                            <i className="fa-solid fa-pen-to-square"></i>
                                        </button>
                                        <button className="activity-button" onClick={() => onDelete(comment.id)}>
                                            <i className="fa-solid fa-trash-can"></i>
                                        </button>
                                    </>
                                )}
                            </div>
                        </div>
                    </div>
                    {isHovering && (
                        <div>
                            <button onClick={() => setCommentType('restaurant')}>餐廳</button>
                            <button onClick={() => setCommentType('note')}>食記</button>
                        </div>
                    )}
                </div>
            );
        }

        function Favorites({ favorite, onDelete }) {
            return (

                <div className="row mt-5 myRecordsTemp align-self-center">
                    <div className="col-2">
                        <div className="myRecordsContainer align-self-center">
                            <img className="activity-image" src={favorite.main_photo} alt={favorite.restaurant_name} />
                        </div>
                    </div>
                    <div className="col-8">
                        <div className="activity-title">
                            <a href="#"><span>{favorite.restaurant_name}</span></a>
                        </div>
                        <div className="row myRecordsInfo container activity-content">
                            <div><span>地址: {favorite.address}</span></div>
                            <div><span>均價: ${favorite.avg_price}</span></div>
                            <div><span>營業時間: {favorite.wd_operating}</span></div>
                        </div>
                    </div>
                    <div className="col-2 myRecordsBtn">
                        <div><span>{favorite.created_at_date}</span><br /><span> {favorite.created_at_time}</span></div>
                        <button className="activity-button" onClick={() => onDelete(favorite.id)}>移除收藏</button>
                    </div>
                </div>

            );
        }
        window.LoadCount++;
        console.log(window.LoadCount);
        // if (window.LoadCount != 0) { stop() }
        ReactDOM.createRoot(document.getElementById('root')).render(

            <MemberActivity />

        );
        //後衛
        window.LoadCount++;
        console.log(window.LoadCount);
    </script>

</body>

</html>