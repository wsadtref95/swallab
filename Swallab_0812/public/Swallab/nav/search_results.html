<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ csrf_token() }}">
    <title>搜尋結果</title>
    <link href="../css/root.css" rel="stylesheet">
    <link href="../css/nav.css" rel="stylesheet">
    <link href="../css/footer.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
        integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        /* 搜尋結果 */
        table {
            border-collapse: collapse;
            width: 100%;
        }

        th,
        td {
            border: 1px solid black;
            padding: 8px;
            text-align: left;
        }

        th {
            background-color: #f2f2f2;
        }
    </style>
</head>

<body>
    <nav class="navbar navbar-expand sticky-top shadow">
        <div class="container">
            <!-- LOGO -->
            <a class="navbar-brand ms-5 col-1" href="../headpage/headpage.html">
                <img src="../images/root/logo.jpg" alt="" class="logo d-inline-block align-text-top">
            </a>
            <!-- 伸縮 -->
            <div class="collapse navbar-collapse col-10" id="navbarSupportedContent">
                <div class="nav ms-0 me-3 row">
                    <div class="nav-item col-6">
                        <!-- 首頁沒有 active -->
                        <!-- <a class="nav-link active" aria-current="page" href="#">Active</a> -->
                        <a class="nav-link d-block nav_mainbtn" href="../restaurant/detail.html">找餐廳</a>
                    </div>
                    <div class="nav-item col-6">
                        <a class="nav-link d-block nav_mainbtn" href="../foodNotes/foodNotes.html">看食記</a>
                    </div>
                </div>
                <!-- Input 都在這 -->
                <form class="ms-2 me-1 w-100" role="search" name="search">
                    <!-- 接後端 Start -->
                    <input type="hidden" name="search_type" id="search_type" value="RestInfos">
                    <!-- 接後端 End -->
                    <div class="d-flex" style="width: 100%;">
                        <!-- hover、click 換 icon -> src="./img/blog.png" -->
                        <div id="theicon" class="theicon mt-2 me-0 align-items-center justify-content-center">
                            <div id="popup" class="popup text-center d-flex align-items-center justify-content-center">
                                <p><i id="showicon" class="fa-solid fa-utensils"></i></p>
                            </div>
                            <div id="popupBR" class="popupBR">
                                <div id="popupBlog" class="col-4 text-center">
                                    <p class="text-center"><i class="fa-solid fa-book-open"></i></p>
                                </div>
                                <div id="popupRest" class="col-4 text-center">
                                    <p><i class="fa-solid fa-utensils"></i></p>
                                </div>
                            </div>
                        </div>



                        <!-- 搜尋框 + 情境按鈕(pill 會改成底線) -->
                        <div class="d-block position-relative m-0 p-0 col">
                            <!-- 搜尋框 start -->
                            <!-- <input class="form-control m-0" type="search" placeholder="Click" aria-label="Search"> -->
                            <div style="display: flex;" clas="row">
                                <div class="col-6">
                                    <input type="text" id="myInput" onclick="myFunction()" placeholder="點擊我"
                                        class="form-control m-0">
                                    <!-- from 資料庫 -->
                                    <div id="myDropdown" class="dropdown-content"
                                        style="display: none; position: absolute;">
                                        <a href="#cate_no" onclick="fillInput('null')"
                                            class="position-relative">不挑分類</a>
                                        <a href="#cate_hotpot" onclick="fillInput('火鍋')"
                                            class="position-relative">火鍋</a>
                                        <a href="#cate_bbq" onclick="fillInput('燒肉')" class="position-relative">燒肉</a>
                                        <a href="#cate_izakaya" onclick="fillInput('居酒屋')"
                                            class="position-relative">居酒屋</a>
                                        <a href="#cate_ramen" onclick="fillInput('拉麵')" class="position-relative">拉麵</a>
                                        <a href="#cate_dessert" onclick="fillInput('甜點')"
                                            class="position-relative">甜點</a>
                                    </div>
                                </div>
                                <div class="col-6">

                                    <input type="text" id="myInput2" onclick="myFunction2()" placeholder="點擊我"
                                        class="form-control m-0 col-6">
                                    <!-- from 資料庫 -->
                                    <div id="myDropdown2" class="dropdown-content"
                                        style="display: none; position: absolute;">
                                        <a href="#loc_no" onclick="fillInput2('null')"
                                            class="position-relative">不挑地區</a>
                                        <a href="#loc_Taichung" onclick="fillInput2('台中市')"
                                            class="position-relative">台中市</a>
                                        <a href="#loc_1" onclick="fillInput2('選項2')" class="position-relative">選項2</a>
                                        <a href="#loc_2" onclick="fillInput2('選項3')" class="position-relative">選項3</a>
                                    </div>
                                </div>
                            </div>



                            <!-- 搜尋框 end -->
                            <button data-purpose="約會" class="position-absolute translate-middle rounded-pill filter_btn"
                                style="margin-left: 10%;">
                                <img class="icon" src="../images/nav_icon/dating.png" alt="">約會
                            </button>
                            <button data-purpose="聚餐" class="position-absolute translate-middle rounded-pill filter_btn"
                                style="margin-left: 30%;">
                                <img class="icon" src="../images/nav_icon/group.png" alt="">聚餐
                            </button>
                            <button data-purpose="慶生" class="position-absolute translate-middle rounded-pill filter_btn"
                                style="margin-left: 50%;">
                                <img class="icon" src="../images/nav_icon/confetti.png" alt="">慶生
                            </button>
                            <button data-purpose="商務" class="position-absolute translate-middle rounded-pill filter_btn"
                                style="margin-left: 70%;">
                                <img class="icon" src="../images/nav_icon/handshake.png" alt="">商務
                            </button>
                            <button data-purpose="無障礙"
                                class="position-absolute translate-middle rounded-pill filter_btn"
                                style="margin-left: 90%;">
                                <img class="icon" src="../images/nav_icon/disabled-people.png" alt="">無障礙
                            </button>
                        </div>
                        <!-- 搜尋 icon = submit -->
                        <input type="image" src="../images/nav_icon/loupe.png" class="icon mt-2 ms-0"
                            onclick="document.search.submit()">
                        <!-- <img src="./img/loupe.png" class="icon mt-2 ms-1" alt="" type="submit"> -->
                    </div>
                </form>
                <!-- 登入及註冊按鈕 -->
                <div class="ms-3 me-5 col-1">
                    <a href="#" class="">
                        <button class="btn btn-sm btnLogin text-nowrap">登入/註冊</button>
                    </a>
                </div>
            </div>
        </div>
    </nav>
    <!-- 呈現搜尋結果 + API URL -->
    <div class="container">
        <h1>搜尋結果</h1>
        <table id="resultsTable">
            <thead>
                <tr id="headerRow"></tr>
            </thead>
            <tbody id="resultsBody"></tbody>
        </table>
    </div>
    <div id="searchResults"></div>
    <div id="pastParam"></div>




    <script>
        // 頁面互動（nav.js)
        // 當滑鼠經過時，顯示兩個 icon
        document.getElementById('theicon').addEventListener('mouseover', function () {
            console.log(123);
            document.getElementById('popupBR').style.display = 'flex';
            document.getElementById('popupBlog').style.display = 'flex';
            document.getElementById('popupRest').style.display = 'flex';
        });

        // 當滑鼠離開時，只顯示已選擇的 icon
        document.getElementById('theicon').addEventListener('mouseout', function () {
            document.getElementById('popupBlog').style.display = 'none';
            document.getElementById('popupRest').style.display = 'none';
        });

        // 點擊時，更換顯示的 icon

        class Theicon {
            constructor(type, icon) {
                this.type = type;
                this.icon = icon;
            }
            toIcon(type) {
                console.log(1);
                return this.icon;
            }
        }

        let restIcon = new Theicon("rest", "fa-solid fa-utensils")
        let blogIcon = new Theicon("blog", "fa-solid fa-book-open")

        window.onload = function () {
            document.getElementById('showicon').className = restIcon.toIcon();
            document.getElementById('popupBlog').addEventListener('click', function () {
                document.getElementById('showicon').className = blogIcon.toIcon();
            })
            document.getElementById('popupRest').addEventListener('click', function () {
                document.getElementById('showicon').className = restIcon.toIcon();
            })
        }

        // 搜尋框
        // 點擊輸入框，切換下拉選單的顯示和隱藏
        function myFunction() {
            var dropdown = document.getElementById("myDropdown");
            if (dropdown.style.display === "none") {
                dropdown.style.display = "block";
            } else {
                dropdown.style.display = "none";
            }
        }

        function myFunction2() {
            var dropdown = document.getElementById("myDropdown2");
            if (dropdown.style.display === "none") {
                dropdown.style.display = "block";
            } else {
                dropdown.style.display = "none";
            }
        }
        // 搜尋框顯示
        function fillInput(value) {
            document.getElementById('myInput').value = value;
            document.getElementById('myDropdown').style.display = "none";
            document.getElementById('myInput2').style.display = "block";
        }

        function fillInput2(value) {
            document.getElementById('myInput2').value = value;
            document.getElementById('myDropdown2').style.display = "none";
            document.getElementById('myInput1').style.display = "block";

            // SQL
            // 'myInput' 和 'myInput2' 的值作為查詢條件
        }
        // 點擊其他地方隱藏下拉

        // 搜尋框
        // 點擊輸入框，切換下拉選單的顯示和隱藏
        function myFunction() {
            var dropdown = document.getElementById("myDropdown");
            if (dropdown.style.display === "none") {
                dropdown.style.display = "block";
            } else {
                dropdown.style.display = "none";
            }
        }

        function myFunction2() {
            var dropdown = document.getElementById("myDropdown2");
            if (dropdown.style.display === "none") {
                dropdown.style.display = "block";
            } else {
                dropdown.style.display = "none";
            }
        }
        // 搜尋框顯示
        function fillInput(value) {
            document.getElementById('myInput').value = value;
            document.getElementById('myDropdown').style.display = "none";
            document.getElementById('myInput2').style.display = "block";
        }

        function fillInput2(value) {
            document.getElementById('myInput2').value = value;
            document.getElementById('myDropdown2').style.display = "none";
            document.getElementById('myInput').style.display = "block";

            // SQL
            // 'myInput' 和 'myInput2' 的值作為查詢條件
        }
        // 點擊其他地方隱藏下拉
        window.onclick = function (event) {
            if (!event.target.matches('#myInput')) {
                var dropdown = document.getElementById("myDropdown");
                if (dropdown.style.display === "block") {
                    dropdown.style.display = "none";
                }
            }

            if (!event.target.matches('#myInput2')) {
                var dropdown = document.getElementById("myDropdown2");
                if (dropdown.style.display === "block") {
                    dropdown.style.display = "none";
                }
            }
        }
        // document.addEventListener('DOMContentLoaded', function () {
        let searchCount;
        if (searchCount != 0) stop()

        const searchForm = document.querySelector('form[name="search"]');
        const searchTypeIcon = document.getElementById('showicon');
        const categoryInput = document.getElementById('myInput');
        const locationInput = document.getElementById('myInput2');
        const purposeInput = document.querySelector('button[data-purpose]');
        const searchButton = document.querySelector('button[type="submit"]');
        const resultsContainer = document.getElementById('searchResults');
        const pastParamContainer = document.getElementById('pastParam');
        const MAX_SEARCHES = 999;
        searchCount = 0;
        console.log(`DOM#${searchCount}`); // 0
        // window.onbeforeunload = function () {
        //     return "Are you sure you want to leave?";
        // };

        function getSearchType() {
            return searchTypeIcon.classList.contains('fa-book-open') ? 'MemberNotes' : 'RestInfos';
        }

        function performSearch() {
            console.log(`start performSearch()#${searchCount}`);
            // debugger;
            if (searchCount >= MAX_SEARCHES) {
                console.log(`已達到最大搜索次數限制${searchCount}`);
                alert('已達到最大搜索次數限制。請刷新頁面以重置。');
                return;
            }

            searchCount++;
            console.log(`執行搜索 #${searchCount}`);

            const searchType = getSearchType();
            const category = categoryInput.value;
            const location = locationInput.value;
            const purpose = purposeInput.getAttribute('data-purpose');

            const searchParams = new URLSearchParams();
            searchParams.append('search_type', searchType);
            if (category) searchParams.append('category', category);
            if (location) searchParams.append('location', location);
            if (purpose) searchParams.append('purpose', purpose);

            console.log(`b4 show URL#${searchCount}`);
            searchCount++;

            const apiUrl = `http://localhost:8000/api/search?${searchParams.toString()}`;
            console.log('API URL:', apiUrl);

            console.log(`after defineURL#${searchCount}`);
            searchCount++;

            // 顯示搜索 URL
            pastParamContainer.innerHTML = `<p>API URL: ${apiUrl}</p>`;

            console.log(`after show URL&b4 fetch#${searchCount}`);
            searchCount++;

            // 發送 API 請求
            fetch(apiUrl)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    console.log(response);
                    return response.json();
                })
                .then(data => {
                    console.log(data[0]);
                    displayResults(data);
                })
                .catch(error => {
                    console.error('搜索錯誤:', error);
                    resultsContainer.innerHTML = '<p>獲取搜索結果時發生錯誤。</p>';
                });

            console.log(`after fetch#${searchCount}`);
            searchCount++;
            // if (searchCount > 1) return;
        }

        console.log(`after performSearch()#${searchCount}`); // 0
        searchCount++;
        // if (searchCount > MAX_SEARCHES) stop();

        function displayResults(data) {
            console.log(`start displayResults()#${searchCount}`); //6
            searchCount++;
            // if (searchCount > MAX_SEARCHES) stop();
            resultsContainer.innerHTML = '';
            if (data.length === 0) {
                console.log(`start .innerHTML#${searchCount}`); //?
                searchCount++;
                resultsContainer.innerHTML = '<p>沒有找到結果</p>';

                // if (searchCount != MAX_SEARCHES) stop();
                // debugger;
                return;
            }
            console.log(data[0]);
            console.log(`after .innerHTML#${searchCount}`); //7
            // debugger;

            console.log(`after appendChild()#${searchCount}`);
            searchCount++;

            const table = document.createElement('table');
            table.border = '1';


            // 創建表頭
            const headerRow = table.insertRow();
            Object.keys(data[0]).forEach(key => {
                const th = document.createElement('th');
                th.textContent = key;
                headerRow.appendChild(th);
            });

            // 填充數據
            data.forEach(item => {
                const row = table.insertRow();
                Object.values(item).forEach(value => {
                    const cell = row.insertCell();
                    cell.textContent = value;
                });
            });
            console.log(`b4 appendChild()#${searchCount}`);
            searchCount++;
            // if (searchCount > MAX_SEARCHES) stop();
            for (i = 0; i < 1; i++) {
                console.log(`searchCount#${searchCount}`);
                resultsContainer.appendChild(table);
            }
            return;
            console.log(`after appendChild()#${searchCount}`);
            searchCount++;
            // if (searchCount > MAX_SEARCHES) stop();
            // debugger; //No.3, After Submit, everything shows up, then reload...
        }
        // debugger; //No.1


        searchForm.addEventListener('submit', function (e) {
            e.preventDefault();
            console.log(`after submit #${searchCount}`); //1
            searchCount++;
            performSearch();
            return false;
        });

        // 圖標切換邏輯
        document.getElementById('popupBlog').addEventListener('click', function () {
            searchTypeIcon.className = 'fa-solid fa-book-open';
        });

        document.getElementById('popupRest').addEventListener('click', function () {
            searchTypeIcon.className = 'fa-solid fa-utensils';
        });
        // debugger; //NO.2, then DOMContentLoaded

        // });
    </script>
    <script src="../js/nav.js"></script>
</body>

</html>