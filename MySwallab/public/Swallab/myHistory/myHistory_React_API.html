<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- css -->
    <link href="../css/root.css" rel="stylesheet">
    <link href="../css/nav.css" rel="stylesheet">
    <link href="../css/footer.css" rel="stylesheet">
    <!-- bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
    <!-- css -->
    <link rel="stylesheet" href="../css/history_react.css">
    <link rel="stylesheet" href="../css/myHistory.css">
    <link rel="stylesheet" href="../css/myHistory_temp_order.css">
    <!-- <link rel="stylesheet" href="../css/history_react.css"> -->
    <!-- icon -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
        integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <!-- React -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>

<body>
    <div id="nav-container"></div>


    <main>
        <div class="w-100 container mt-5" style="flex:1">
            <div id="root"></div>

            <!-- main content_end -->

        </div>
    </main>

    <div id="footer-container"></div>


    <!-- React -->
    <script src="../js/config.js"></script>
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        window.LoadCount = 0;
        const ErrorBoundary = ({ children }) => {
            const [hasError, setHasError] = React.useState(false);
            const [error, setError] = React.useState(null);

            React.useEffect(() => {
                const errorHandler = (error) => {
                    console.error("Caught an error:", error);
                    setHasError(true);
                    setError(error);
                };

                window.addEventListener('error', errorHandler);

                return () => {
                    window.removeEventListener('error', errorHandler);
                };
            }, []);

            if (hasError) {
                return <h1>Something went wrong. Error: {error?.message}</h1>;
            }

            return children;
        };
        // <!-- mockData ok -->
        // const mockData = {
        //     all: [
        //         ...[...Array(10)].map((_, index) => ({
        //             id: index + 1,
        //             type: 'order',
        //             restaurant_name: `餐廳${String.fromCharCode(65 + index)}`,
        //             restaurant_image: `https://placehold.co/100x100?text=餐廳${String.fromCharCode(65 + index)}`,
        //             items: [{ item_qty: 2, item_price: 100 + index * 10, item_name: `餐點${String.fromCharCode(65 + index)}` }],
        //             total_price: 200 + index * 20,
        //             created_at_date: `2024-02-${String(index + 1).padStart(2, '0')}`,
        //             created_at_time: `${String(12 + index).padStart(2, '0')}:00`
        //         })),
        //         ...[...Array(10)].map((_, index) => ({
        //             id: index + 11,
        //             type: 'note',
        //             title: `美食記錄 ${index + 1}`,
        //             main_photo: `https://placehold.co/100x100?text=美食記錄${index + 1}`,
        //             content: `這是第 ${index + 1} 次的美食體驗`,
        //             restaurant_name: `餐廳${String.fromCharCode(75 + index)}`,
        //             created_at_date: `2024-01-${String(index + 1).padStart(2, '0')}`,
        //             created_at_time: `${String(13 + index).padStart(2, '0')}:00`
        //         })),
        //         ...[...Array(10)].map((_, index) => ({
        //             id: index + 21,
        //             type: 'comment',
        //             content: `這是第 ${index + 1} 條評論`,
        //             restaurant_name: `餐廳${String.fromCharCode(85 + index)}`,
        //             restaurant_image: `https://placehold.co/100x100?text=餐廳${String.fromCharCode(85 + index)}`,
        //             created_at_date: `2024-03-${String(index + 1).padStart(2, '0')}`,
        //             created_at_time: `${String(14 + index).padStart(2, '0')}:00`
        //         })),
        //         ...[...Array(10)].map((_, index) => ({
        //             id: index + 31,
        //             type: 'favorite',
        //             restaurant_name: `餐廳${String.fromCharCode(95 + index)}`,
        //             main_photo: `https://placehold.co/100x100?text=餐廳${String.fromCharCode(95 + index)}`,
        //             address: `台北市${['中山', '大安', '信義', '松山', '內湖', '南港', '士林', '北投', '文山', '萬華'][index]}區`,
        //             avg_price: 300 + index * 50,
        //             wd_operating: `${11 + index}:00-${21 + index}:00`,
        //             created_at_date: `2024-04-${String(index + 1).padStart(2, '0')}`,
        //             created_at_time: `${String(15 + index).padStart(2, '0')}:00`
        //         }))
        //     ],
        //     OrderInfos: [...Array(10)].map((_, index) => ({
        //         id: index + 1,
        //         type: 'order',
        //         restaurant_name: `餐廳${String.fromCharCode(65 + index)}`,
        //         restaurant_image: `https://placehold.co/100x100?text=餐廳${String.fromCharCode(65 + index)}`,
        //         items: [{ item_qty: 2, item_price: 100 + index * 10, item_name: `餐點${String.fromCharCode(65 + index)}` }],
        //         total_price: 200 + index * 20,
        //         created_at_date: `2024-02-${String(index + 1).padStart(2, '0')}`,
        //         created_at_time: `${String(12 + index).padStart(2, '0')}:00`
        //     })),
        //     MemberNotes: [...Array(10)].map((_, index) => ({
        //         id: index + 11,
        //         type: 'note',
        //         title: `美食記錄 ${index + 1}`,
        //         main_photo: `https://placehold.co/100x100?text=美食記錄${index + 1}`,
        //         content: `這是第 ${index + 1} 次的美食體驗`,
        //         restaurant_name: `餐廳${String.fromCharCode(75 + index)}`,
        //         created_at_date: `2024-01-${String(index + 1).padStart(2, '0')}`,
        //         created_at_time: `${String(13 + index).padStart(2, '0')}:00`
        //     })),
        //     Comments: [...Array(10)].map((_, index) => ({
        //         id: index + 21,
        //         type: 'comment',
        //         content: `這是第 ${index + 1} 條評論`,
        //         restaurant_name: `餐廳${String.fromCharCode(85 + index)}`,
        //         restaurant_image: `https://placehold.co/100x100?text=餐廳${String.fromCharCode(85 + index)}`,
        //         created_at_date: `2024-03-${String(index + 1).padStart(2, '0')}`,
        //         created_at_time: `${String(14 + index).padStart(2, '0')}:00`
        //     })),
        //     Favorites: [...Array(10)].map((_, index) => ({
        //         id: index + 31,
        //         type: 'favorite',
        //         restaurant_name: `餐廳${String.fromCharCode(95 + index)}`,
        //         main_photo: `https://placehold.co/100x100?text=餐廳${String.fromCharCode(95 + index)}`,
        //         address: `台北市${['中山', '大安', '信義', '松山', '內湖', '南港', '士林', '北投', '文山', '萬華'][index]}區`,
        //         avg_price: 300 + index * 50,
        //         wd_operating: `${11 + index}:00-${21 + index}:00`,
        //         created_at_date: `2024-04-${String(index + 1).padStart(2, '0')}`,
        //         created_at_time: `${String(15 + index).padStart(2, '0')}:00`
        //     }))
        // };

        // function MemberActivity() {
        //     const [activeTab, setActiveTab] = useState('all');
        //     const [activities, setActivities] = useState([]);
        //     const [displayedActivities, setDisplayedActivities] = useState([]);
        //     const [hasMore, setHasMore] = useState(true);
        //     const isLoadingRef = useRef(false);
        //     const [expanded, setExpanded] = useState(false);

        //     useEffect(() => {
        //         fetchActivities();
        //     }, [activeTab]);

        //     const fetchActivities = async () => {
        //         isLoadingRef.current = true;
        //         try {
        //             // 模擬 API 調用
        //             const data = mockData[activeTab] || mockData.all;
        //             // 按時間從新到舊排序
        //             const sortedData = data.sort((a, b) => {
        //                 const dateA = new Date(a.created_at_date + ' ' + a.created_at_time);
        //                 const dateB = new Date(b.created_at_date + ' ' + b.created_at_time);
        //                 return dateB - dateA;
        //             });
        //             setActivities(sortedData);
        //             setDisplayedActivities(sortedData.slice(0, 4));
        //             setHasMore(sortedData.length > 4);
        //             setExpanded(false);
        //             isLoadingRef.current = false;
        //         } catch (error) {
        //             console.error('Error fetching activities:', error);
        //             isLoadingRef.current = false;
        //         }
        //     };

        //     const handleTabChange = (tab) => {
        //         setActiveTab(tab);
        //         setExpanded(false);
        //     };

        //     const handleLoadMore = () => {
        //         setDisplayedActivities(activities);
        //         setExpanded(true);
        //         setHasMore(false);
        //     };

        //     const handleEditComment = (id, content) => {
        //         console.log(`Editing comment ${id} with content: ${content}`);
        //         // 實際應用中應調用 API
        //     };

        //     const handleDeleteComment = (id) => {
        //         console.log(`Deleting comment ${id}`);
        //         // 實際應用中應調用 API
        //     };

        //     const handleDeleteFavorite = (id) => {
        //         const confirmed = window.confirm('確定要移除收藏嗎？');
        //         if (confirmed) {
        //             console.log(`Deleting favorite ${id}`);
        //             // 實際應用中應調用 API
        //         }
        //     };


        // 設置 API 基礎 URL
        const API_BASE_URL = 'http://localhost:8000/api';
        function MemberActivity() {
            const [state, setState] = useState({
                activeTab: 'all',
                activities: [],
                hasMore: true,
                currentPage: 1,
                isLoading: true
            });

            useEffect(() => {
                fetchAllActivities();
            }, []);

            const fetchAllActivities = async () => {

                try {
                    setState(prev => ({ ...prev, isLoading: true }));
                    const response = await fetch(`${API_BASE_URL}/member-activity/all`);
                    if (!response.ok) throw new Error('Network response was not ok');
                    const data = await response.json();
                    const sortedActivities = sortActivitiesByDate(data);
                    setState(prev => ({
                        ...prev,
                        activities: sortedActivities,
                        isLoading: false
                    }));
                } catch (error) {
                    console.error('Error fetching all activities:', error);
                    setState(prev => ({ ...prev, isLoading: false }));
                }
            };

            let endpoint;
            if (activeTab === 'Comments') {
                endpoint = commentType === 'rest' ? '/RestComments' : '/NotesComments';
            } else if (activeTab === 'Favorites') {
                endpoint = favoriteType === 'rest' ? '/RestFavorites' : '/NotesFavorites';
            } else {
                endpoint = activeTab === 'all' ? '/all' : `/${activeTab}`;
            }

            const handleTabChange = async (tab) => {
                setState(prev => ({ ...prev, activeTab: tab, isLoading: true }));
                if (tab === 'all') {
                    await fetchAllActivities();
                } else {
                    try {
                        const response = await fetch(`${API_BASE_URL}/member-activity/${tab}?page=1&limit=10`);
                        if (!response.ok) throw new Error('Network response was not ok');
                        const data = await response.json();
                        setState(prev => ({
                            ...prev,
                            activities: data.data,
                            hasMore: data.next_page_url !== null,
                            currentPage: 1,
                            isLoading: false
                        }));
                    } catch (error) {
                        console.error(`Error fetching ${tab} activities:`, error);
                        setState(prev => ({ ...prev, isLoading: false }));
                    }
                }
            };

            const handleLoadMore = async () => {
                if (state.activeTab === 'all' || state.isLoading) return;

                try {
                    setState(prev => ({ ...prev, isLoading: true }));
                    const response = await fetch(`${API_BASE_URL}/member-activity/${state.activeTab}?page=${state.currentPage + 1}&limit=10`);
                    if (!response.ok) throw new Error('Network response was not ok');
                    const data = await response.json();
                    setState(prev => ({
                        ...prev,
                        activities: [...prev.activities, ...data.data],
                        hasMore: data.next_page_url !== null,
                        currentPage: prev.currentPage + 1,
                        isLoading: false
                    }));
                } catch (error) {
                    console.error('Error loading more activities:', error);
                    setState(prev => ({ ...prev, isLoading: false }));
                }
            };

            const sortActivitiesByDate = (data) => {
                const allActivities = [
                    ...(data.orders || []).map(item => ({ ...item, type: 'order' })),
                    ...(data.notes || []).map(item => ({ ...item, type: 'note' })),
                    ...(data.comments || []).map(item => ({ ...item, type: 'comment' })),
                    ...(data.favorites || []).map(item => ({ ...item, type: 'favorite' }))
                ];
                return allActivities.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
            };

            return (
                <div className="member-activity-container">
                    <div className="rightpart">
                        <div id="sidebar" className="sidebar col-2 text-center">
                            <div className="col align-self-center">
                                <a href="#"><p>個人檔案</p></a>
                                <a href="#"><p>我的訂單</p></a>
                                <a href="#" className="active"><p>歷史紀錄</p></a>
                                <a href="#"><p>發布食記</p></a>
                            </div>
                        </div>
                        <div className="col">
                            <div className="breadcrumb">
                                <a href="#">會員中心</a>
                                <span> → </span>
                                <a href="./myHistory.html" className="active">歷史紀錄</a>
                            </div>
                            <div className="row ms-5 justify-content-center">
                                {['all', 'OrderInfos', 'MemberNotes', 'Comments', 'Favorites'].map(tab => (
                                    <div className="col-2" key={tab}>
                                        <button
                                            className={`btn btn-outline-success tab-button ${state.activeTab === tab ? 'active' : ''}`}
                                            onClick={() => handleTabChange(tab)}
                                        >
                                            {tab === 'all' ? '全部' :
                                                tab === 'OrderInfos' ? '歷史訂單' :
                                                    tab === 'MemberNotes' ? '歷史食記' :
                                                        tab === 'Comments' ? '我的評論' : '我的收藏'}
                                        </button>
                                    </div>
                                ))}
                                <hr className="mt-3" />
                            </div>

                            {state.isLoading ? (
                                <p>Loading...</p>
                            ) : (
                                state.activities.map(activity => {
                                    switch (activity.type) {
                                        case 'order':
                                            return <OrderInfos key={`order-${activity.id}`} order={activity} />;
                                        case 'note':
                                            return <MemberNotes key={`note-${activity.id}`} note={activity} />;
                                        case 'comment':
                                            return <Comments key={`comment-${activity.id}`} comment={activity} />;
                                        case 'favorite':
                                            return <Favorites key={`favorite-${activity.id}`} favorite={activity} />;
                                        default:
                                            return null;
                                    }
                                })
                            )

                            }
                            {activeTab === 'Comments' && (
                                <div>
                                    <button onClick={() => setCommentType('rest')}>餐廳評論</button>
                                    <button onClick={() => setCommentType('notes')}>食記評論</button>
                                </div>
                            )}

                            {activeTab === 'Favorites' && (
                                <div>
                                    <button onClick={() => setFavoriteType('rest')}>餐廳收藏</button>
                                    <button onClick={() => setFavoriteType('notes')}>食記收藏</button>
                                </div>
                            )}
                            {state.hasMore && !state.isLoading && state.activeTab !== 'all' && (
                                <button className="btn btn-outline-success" onClick={handleLoadMore}>觀看更多</button>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        function OrderInfos({ order }) {
            return (
                <div className="row mt-5 myRecordsTemp align-self-center">
                    <div className="col-2">
                        <div className="myRecordsContainer align-self-center">
                            <img className="activity-image" src={order.restaurant_image} alt={order.restaurant_name} />
                        </div>
                    </div>
                    <div className="col-1"></div>
                    <div className="col-5">
                        <div className="activity-title">
                            <div>訂單狀態：已完成</div>
                            <a href="#"><span>{order.restaurant_name}</span></a>
                        </div>
                        <div className="row myRecordsInfo container">
                            {order.items.map((item, index) => (
                                <div key={index}>
                                    {item.item_qty}份 {item.item_price}的 {item.item_name} <br />
                                    {item.item_qty}份 {item.item_price}的 {item.item_name} <br />
                                    {item.item_qty}份 {item.item_price}的 {item.item_name}
                                </div>
                            ))}
                            <a href="" className="me-0">more...</a>
                        </div>
                    </div>
                    <div className="col-1 align-items-center">
                        <div><span>${order.total_price} </span></div>
                    </div>
                    <div className="col-2 myRecordsBtn">
                        <div><span>{order.created_at_date}</span></div>
                        <button className="activity-button">再次訂購</button>
                    </div>
                    <div className="col-1"></div>

                </div>
            );
        }

        function MemberNotes({ note }) {
            return (

                <div className="row mt-5 myRecordsTemp align-self-center">
                    <div className="col-2">
                        <div className="myRecordsContainer align-self-center">
                            <img className="activity-image" src={note.main_photo} alt={note.title} />
                        </div>
                    </div>
                    <div className="col-8">
                        <div className="row activity-title">
                            <a href=""><span>{note.title}</span></a>
                        </div>
                        <div className="row myRecordsInfo container-fluid myNotes">
                            <div className="activity-content">{note.content}</div>
                        </div>
                    </div>
                    <div className="col-2">
                        <div><span>{note.created_at_date}</span> <br /><span>{note.created_at_time}</span> </div>
                        <div className="activity-buttons">
                            <button className="activity-button">
                                <i className="fa-solid fa-pen-to-square"></i>
                            </button>
                            <button className="activity-button">
                                <i className="fa-solid fa-trash-can"></i>
                            </button>
                        </div>
                    </div>
                </div>
            );
        }
        //後衛
        window.LoadCount++;
        console.log(window.LoadCount);
        // if (window.LoadCount != 0) { stop() }
        function Comments({ comment, onEdit, onDelete }) {
            const [isEditing, setIsEditing] = useState(false);
            const [editedContent, setEditedContent] = useState(comment.content);

            const handleEdit = () => {
                onEdit(comment.id, editedContent);
                setIsEditing(false);
            };
            //後衛
            window.LoadCount++;
            console.log(window.LoadCount);
            // if (window.LoadCount != 0) { stop() }
            return (

                <div className="row mt-5 myRecordsTemp align-self-center">
                    <div className="col-2">
                        <div className="myRecordsContainer align-self-center">
                            <img className="activity-image" src={comment.restaurant_image} alt={comment.restaurant_name} />
                        </div>
                    </div>
                    <div className="col-8">
                        <div className="row myRecordsTitle">
                            <a href="#"><span>{comment.restaurant_name}</span></a>
                        </div>
                        <div className="row myRecordsContent container">
                            {isEditing ? (
                                <textarea
                                    value={editedContent}
                                    onChange={(e) => setEditedContent(e.target.value)}
                                />
                            ) : (
                                comment.content
                            )}
                        </div>
                    </div>
                    <div className="col-2">
                        <div><span>{comment.created_at_date}</span> <br /><span>{comment.created_at_time}</span> </div>
                        <div className="activity-buttons">
                            {isEditing ? (
                                <>
                                    <button className="activity-button" onClick={handleEdit}>保存</button>
                                    <button className="activity-button" onClick={() => setIsEditing(false)}>取消</button>
                                </>
                            ) : (
                                <>
                                    <button className="activity-button" onClick={() => setIsEditing(true)}>
                                        <i className="fa-solid fa-pen-to-square"></i>
                                    </button>
                                    <button className="activity-button" onClick={() => onDelete(comment.id)}>
                                        <i className="fa-solid fa-trash-can"></i>
                                    </button>
                                </>
                            )}
                        </div>
                    </div>
                </div>

            );
        }
        //後衛
        window.LoadCount++;
        console.log(window.LoadCount);
        // if (window.LoadCount != 0) { stop() }
        function Favorites({ favorite, onDelete }) {
            return (

                <div className="row mt-5 myRecordsTemp align-self-center">
                    <div className="col-2">
                        <div className="myRecordsContainer align-self-center">
                            <img className="activity-image" src={favorite.main_photo} alt={favorite.restaurant_name} />
                        </div>
                    </div>
                    <div className="col-8">
                        <div className="activity-title">
                            <a href="#"><span>{favorite.restaurant_name}</span></a>
                        </div>
                        <div className="row myRecordsInfo container activity-content">
                            <div><span>地址: {favorite.address}</span></div>
                            <div><span>均價: ${favorite.avg_price}</span></div>
                            <div><span>營業時間: {favorite.wd_operating}</span></div>
                        </div>
                    </div>
                    <div className="col-2 myRecordsBtn">
                        <div><span>{favorite.created_at_date}</span><br /><span> {favorite.created_at_time}</span></div>
                        <button className="activity-button" onClick={() => onDelete(favorite.id)}>移除收藏</button>
                    </div>
                </div>

            );
        }

        //後衛
        window.LoadCount++;
        console.log(window.LoadCount);
        // if (window.LoadCount != 0) { stop() }
        ReactDOM.createRoot(document.getElementById('root')).render(
            <MemberActivity />
        );
        //後衛
        window.LoadCount++;
        console.log(window.LoadCount);
        // if (window.LoadCount != 0) { stop() }


        // window.MemberActivity = MemberActivity;
        // window.OrderInfos = OrderInfos;
        // window.Comments = Comments;
        // window.MemberNotes = MemberNotes;
        // window.Favorites = Favorites;
        // localStorage.setItem('MemberActivity', JSON.stringify(MemberActivity()));
        // localStorage.setItem('OrderInfos', JSON.stringify(MemberActivity()));
        // localStorage.setItem('Comments', JSON.stringify(MemberActivity()));
        // localStorage.setItem('MemberNotes', JSON.stringify(MemberActivity()));
        // localStorage.setItem('Favorites', JSON.stringify(MemberActivity()));

    </script>
    <!-- <script src=""></script> -->
</body>

</html>